<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>领导预约协同中心</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-bg { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        /* 预约蓝色弹窗 */
        .modal-header-blue { background: #3b82f6; color: white; padding: 16px 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        /* 驳回红色弹窗 */
        .modal-header-red { background: white; color: #dc2626; padding: 24px 24px 0 24px; border-radius: 24px 24px 0 0; }
        .reject-input { background: #fff1f2; border: 1px solid #fecdd3; color: #e11d48; }
        .reject-input::placeholder { color: #fda4af; }
    </style>
</head>
<body class="bg-[#f3f4f6] text-slate-800 h-screen overflow-hidden">
<div id="app" class="h-full flex flex-col relative">
    <div class="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-blue-600 to-indigo-900 -z-10 rounded-b-[3rem] shadow-2xl"></div>

    <div v-if="currentView === 'login'" class="flex-1 flex items-center justify-center p-6 z-10">
        <div class="glass-bg w-full max-w-4xl h-[500px] rounded-3xl shadow-2xl flex overflow-hidden border border-white/50">
            <div class="hidden md:flex w-1/2 bg-blue-600 text-white flex-col justify-center items-center p-12">
                <h1 class="text-4xl font-bold mb-4 tracking-wider">预约协同</h1><p class="text-blue-100">PythonAnywhere 云端版</p>
            </div>
            <div class="w-full md:w-1/2 p-10 flex flex-col justify-center bg-white">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">欢迎登录</h2>
                <div class="bg-gray-100 p-1 rounded-xl flex mb-8">
                    <button @click="loginTab = 'user'" :class="loginTab === 'user' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all">员工通道</button>
                    <button @click="loginTab = 'admin'" :class="loginTab === 'admin' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500'" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all">管理后台</button>
                </div>
                <div v-if="loginTab === 'user'" class="space-y-4">
                    <input v-model="userLoginInfo.name" placeholder="真实姓名" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-blue-500/20">
                    <input v-model="userLoginInfo.unit" placeholder="所属单位" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-blue-500/20">
                    <button @click="handleUserLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95">进入系统</button>
                </div>
                <div v-else class="space-y-4">
                    <input v-model="adminLoginInfo.password" type="password" placeholder="请输入密码 (默认 admin)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-indigo-500/20" @keyup.enter="handleAdminLogin">
                    <button @click="handleAdminLogin" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95">后台登录</button>
                </div>
            </div>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col max-w-6xl mx-auto w-full h-screen shadow-2xl bg-white md:rounded-t-3xl overflow-hidden mt-0 md:mt-10 z-10 animate-fade-in">
        <header class="bg-white border-b px-6 py-4 flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md" :class="role === 'admin' ? 'bg-gray-800' : 'bg-blue-600'">{{ role === 'admin' ? '管' : '员' }}</div>
                <div><h1 class="font-bold text-lg text-gray-800">{{ role === 'admin' ? '审批工作台' : '预约看板' }}</h1><p v-if="role === 'user'" class="text-xs text-gray-400">{{userLoginInfo.name}} · {{userLoginInfo.unit}}</p></div>
            </div>
            <div class="flex gap-2">
                <button v-if="role === 'admin'" @click="showPwdModal = true" class="text-sm bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-gray-200 font-bold">改密</button>
                <button @click="logout" class="text-sm text-red-500 font-medium px-3 py-1.5 hover:bg-red-50 rounded-lg">退出</button>
            </div>
        </header>

        <div v-if="role === 'user'" class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50">
            <div class="bg-white px-6 py-4 border-b flex flex-col md:flex-row gap-4 items-center justify-between shadow-sm z-10">
                <div class="flex gap-3 overflow-x-auto hide-scroll w-full md:w-auto py-1">
                    <div v-for="leader in leaders" :key="leader" @click="currentLeader = leader" class="flex items-center gap-2 px-1 cursor-pointer group rounded-full pr-4 transition-all" :class="currentLeader === leader ? 'bg-blue-50 ring-2 ring-blue-500' : 'hover:bg-gray-50'">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm bg-blue-500">{{ leader.slice(0, 1) }}</div>
                        <span class="text-sm font-bold" :class="currentLeader === leader ? 'text-blue-700' : 'text-gray-600'">{{ leader }}</span>
                    </div>
                </div>
                <div class="flex items-center bg-white border border-gray-200 rounded-xl shadow-sm ml-auto">
                    <button @click="changeWeek(-1)" class="px-3 py-2 hover:bg-gray-50 text-gray-500">◀</button>
                    <div class="px-4 py-2 text-sm font-mono font-bold text-gray-700 min-w-[140px] text-center">{{ dateRangeDisplay }}</div>
                    <button @click="changeWeek(1)" class="px-3 py-2 hover:bg-gray-50 text-gray-500">▶</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="grid grid-cols-6 border-b divide-x bg-gray-50/50 sticky top-0 z-10">
                        <div class="p-3 text-center text-xs font-bold text-gray-400 py-4">时间</div>
                        <div v-for="dayObj in currentWeekList" :key="dayObj.dateStr" class="p-3 text-center" :class="isToday(dayObj.dateStr) ? 'bg-blue-50/50' : ''">
                            <div class="text-sm font-bold text-gray-800">{{ dayObj.dayName }}</div><div class="text-xs text-gray-400 mt-1 font-mono">{{ dayObj.shortDate }}</div>
                        </div>
                    </div>
                    <div v-for="time in timeSlots" :key="time" class="grid grid-cols-6 border-b last:border-0 divide-x h-20 group">
                        <div class="flex items-center justify-center text-xs font-mono font-medium text-gray-400 bg-gray-50/30">{{ time }}</div>
                        <div v-for="dayObj in currentWeekList" :key="dayObj.dateStr" @click="handleCellClick(dayObj, time)" class="relative p-1 hover:bg-gray-50 cursor-pointer" :class="isToday(dayObj.dateStr) ? 'bg-blue-50/20' : ''">
                            <div v-if="getCellStatus(dayObj.dateStr, time) === 'free'" class="w-full h-full flex items-center justify-center opacity-0 hover:opacity-100 text-blue-400 text-2xl font-light border-2 border-dashed border-gray-200 rounded-lg transition-all">+</div>
                            <div v-else-if="getCellStatus(dayObj.dateStr, time) === 'booked'" class="w-full h-full bg-indigo-50 border border-indigo-100 rounded-lg p-1 flex flex-col justify-center items-start"><span class="bg-indigo-100 text-indigo-700 text-[10px] px-1.5 py-0.5 rounded font-bold mb-1">已占</span></div>
                            <div v-else-if="getCellStatus(dayObj.dateStr, time) === 'pending'" class="w-full h-full bg-amber-50 border border-amber-100 rounded-lg p-1 flex flex-col justify-center items-start"><span class="bg-amber-100 text-amber-700 text-[10px] px-1.5 py-0.5 rounded font-bold mb-1">审核中</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="flex-1 overflow-hidden flex flex-col bg-gray-50">
            <div class="bg-white border-b px-6 py-0 flex gap-6 shadow-sm z-10">
                <button @click="adminTab = 'pending'" :class="adminTab==='pending'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500 hover:text-gray-700'" class="py-4 font-bold text-sm transition-all">待办审批 ({{ pendingApps.length }})</button>
                <button @click="adminTab = 'history'" :class="adminTab==='history'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500 hover:text-gray-700'" class="py-4 font-bold text-sm transition-all">已办清单</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-6">
                <div v-if="adminTab === 'pending'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-if="pendingApps.length === 0" class="col-span-full text-center text-gray-400 py-20 bg-white rounded-2xl border border-gray-100 dashed">暂无待办事项</div>
                    <div v-for="app in pendingApps" :key="app.id" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all">
                        <div class="px-5 py-3 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                            <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">{{ app.leader.slice(0,1) }}</div><span class="font-bold text-gray-700">{{ app.leader }}</span></div>
                            <span class="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">{{ app.date }} {{ app.time }}</span>
                        </div>
                        <div class="p-5">
                            <div class="flex justify-between text-sm mb-3">
                                <div><p class="text-xs text-gray-400">申请人</p><p class="font-bold text-gray-800">{{ app.applicantName }}</p></div>
                                <div class="text-right"><p class="text-xs text-gray-400">单位</p><p class="font-bold text-gray-800">{{ app.applicantUnit }}</p></div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm text-gray-700 border border-gray-100">{{ app.reason }}</div>
                            <div class="flex gap-3">
                                <button @click="handleApprove(app.id)" class="flex-1 bg-green-500 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-green-600 shadow-sm transition-all">通过</button>
                                <button @click="openRejectModal(app.id)" class="flex-1 bg-white border border-red-100 text-red-500 py-2.5 rounded-lg text-sm font-bold hover:bg-red-50 transition-all">驳回</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="space-y-3">
                    <div v-if="historyApps.length === 0" class="text-center text-gray-400 py-20">暂无历史记录</div>
                    <div v-for="app in historyApps" :key="app.id" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center hover:bg-gray-50 transition-all">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-gray-700">{{ app.applicantName }}</span>
                                <span class="text-xs text-gray-400 px-1">预约</span>
                                <span class="font-bold text-gray-700">{{ app.leader }}</span>
                            </div>
                            <div class="text-xs text-gray-400">{{ app.date }} {{ app.time }}</div>
                            <div v-if="app.rejectSuggestion" class="text-xs text-red-400 mt-1 font-bold">建议: {{ app.rejectSuggestion }}</div>
                        </div>
                        <span :class="app.status === 'booked' ? 'bg-green-50 text-green-600 border-green-100' : 'bg-red-50 text-red-600 border-red-100'" class="px-3 py-1 rounded-full text-xs font-bold border">
                            {{ app.status === 'booked' ? '已通过' : '已驳回' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showBookingModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/40 backdrop-blur-sm">
        <div class="w-full max-w-[340px] bg-white rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="modal-header-blue">
                <h3 class="font-bold text-lg">提交预约申请</h3>
                <button @click="showBookingModal = false" class="text-white/80 hover:text-white text-xl">×</button>
            </div>
            <div class="p-6">
                <div class="bg-[#eff6ff] rounded-xl p-4 flex items-center gap-3 mb-5">
                    <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg shadow-sm">{{ currentLeader.slice(0,1) }}</div>
                    <div><div class="text-xs text-gray-500 mb-0.5">预约对象</div><div class="font-bold text-gray-800">{{ currentLeader }}</div></div>
                    <div class="ml-auto text-right"><div class="text-xs text-gray-500 mb-0.5">时间</div><div class="font-bold text-blue-600 font-mono">{{ selectedSlot.date }} {{ selectedSlot.time }}</div></div>
                </div>
                <div class="space-y-3 mb-6">
                    <div class="grid grid-cols-2 gap-3">
                        <div><div class="text-xs text-gray-500 mb-1 ml-1">申请人</div><input v-model="userLoginInfo.name" readonly class="w-full bg-gray-50 border border-gray-100 rounded-lg p-2 text-sm text-gray-600"></div>
                        <div><div class="text-xs text-gray-500 mb-1 ml-1">单位</div><input v-model="userLoginInfo.unit" readonly class="w-full bg-gray-50 border border-gray-100 rounded-lg p-2 text-sm text-gray-600"></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 mb-1 ml-1">预约事由 <span class="text-red-500">*</span></div>
                        <textarea v-model="bookingForm.reason" placeholder="请详细描述预约事由..." class="w-full bg-gray-50 border border-gray-100 rounded-lg p-3 text-sm h-24 outline-none focus:ring-2 ring-blue-500/10 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button @click="showBookingModal = false" class="flex-1 py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold text-sm hover:bg-gray-200">取消</button>
                    <button @click="submitBooking" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700 shadow-lg">确认提交</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showRejectModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/40 backdrop-blur-sm">
        <div class="w-full max-w-[340px] bg-white rounded-[24px] shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="modal-header-red">
                <h3 class="font-bold text-xl mb-2">驳回申请</h3>
                <p class="text-xs text-gray-500 mb-4">请务必给出建议时间，以便申请人重新安排。</p>
            </div>
            <div class="px-6 pb-6 pt-2">
                <div class="mb-6">
                    <div class="text-sm font-bold text-gray-700 mb-2">建议调整至:</div>
                    <input v-model="rejectForm.suggestion" placeholder="例如：周三上午 10:00" class="w-full reject-input rounded-xl p-3 text-sm outline-none focus:ring-2 ring-red-500/20">
                </div>
                <div class="flex gap-3">
                    <button @click="showRejectModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-200">取消</button>
                    <button @click="confirmReject" class="flex-1 py-3 bg-[#ef4444] text-white rounded-xl font-bold text-sm hover:bg-red-600 shadow-lg shadow-red-500/30">确认驳回</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showPwdModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/40 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
            <h3 class="font-bold text-lg mb-4 text-center">修改管理员密码</h3>
            <div class="space-y-4">
                <input v-model="pwdForm.old" type="password" placeholder="原密码" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm">
                <input v-model="pwdForm.new" type="password" placeholder="新密码" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm">
            </div>
            <div class="mt-6 flex gap-3">
                <button @click="showPwdModal = false" class="flex-1 py-2.5 bg-gray-100 rounded-xl text-gray-600">取消</button>
                <button @click="changePassword" class="flex-1 py-2.5 bg-gray-800 text-white rounded-xl font-bold">确认修改</button>
            </div>
        </div>
    </div>
</div>
<script>
    const { createApp } = Vue;
    createApp({
        data() {
            return {
                currentView: 'login', loginTab: 'user', role: 'user', adminTab: 'pending',
                userLoginInfo: { name: '', unit: '' }, adminLoginInfo: { password: '' },
                currentDateAnchor: new Date(), currentLeader: '李旭', leaders: ['李旭', '黄坤鹏', '赵平', '刘亮', '王大伟'],
                timeSlots: ['09:00','10:00','11:00','14:00','15:00','16:00'], appointments: [],
                showBookingModal: false, selectedSlot: {}, bookingForm: { reason: '' },
                showPwdModal: false, pwdForm: { old: '', new: '' },
                showRejectModal: false, rejectForm: { id: null, suggestion: '' }
            }
        },
        mounted() {
            this.fetchData(); setInterval(this.fetchData, 5000);
            const savedUser = localStorage.getItem('booking_user');
            if(savedUser) { this.userLoginInfo = JSON.parse(savedUser); }
        },
        computed: {
            currentWeekList() {
                const list=[]; const anchor=new Date(this.currentDateAnchor); const day=anchor.getDay();
                const diff=anchor.getDate()-day+(day===0?-6:1); const monday=new Date(anchor.setDate(diff));
                const names=['周一','周二','周三','周四','周五'];
                for(let i=0;i<5;i++){ let d=new Date(monday); d.setDate(monday.getDate()+i); list.push({dayName:names[i], dateStr:this.formatDate(d), shortDate:`${d.getMonth()+1}/${d.getDate()}`}); }
                return list;
            },
            dateRangeDisplay() { if(this.currentWeekList.length===0) return ''; return `${this.currentWeekList[0].shortDate} - ${this.currentWeekList[4].shortDate}`; },
            pendingApps() { return this.appointments.filter(a => a.status === 'pending').reverse(); },
            historyApps() { return this.appointments.filter(a => a.status !== 'pending').reverse(); }
        },
        methods: {
            async fetchData() { try { const res = await fetch('/api/appointments'); if(res.ok) this.appointments = await res.json(); } catch(e){} },
            formatDate(date) { const y=date.getFullYear(); const m=(date.getMonth()+1).toString().padStart(2,'0'); const d=date.getDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; },
            isToday(d) { return d === this.formatDate(new Date()); },
            changeWeek(off) { const n=new Date(this.currentDateAnchor); n.setDate(n.getDate()+off*7); this.currentDateAnchor=n; },
            
            handleUserLogin() {
                if(!this.userLoginInfo.name || !this.userLoginInfo.unit) return alert('请完善信息');
                localStorage.setItem('booking_user', JSON.stringify(this.userLoginInfo));
                this.role='user'; this.currentView='main'; this.fetchData();
            },
            async handleAdminLogin() {
                const res = await fetch('/api/login_check', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:this.adminLoginInfo.password}) });
                if(res.ok) { this.role='admin'; this.currentView='main'; this.fetchData(); } else { alert('密码错误'); }
            },
            logout() { this.currentView='login'; this.adminLoginInfo.password=''; },
            
            getCellStatus(d, t) { 
                const a = this.appointments.find(i => i.leader===this.currentLeader && i.date===d && i.time===t); 
                if (!a || a.status === 'rejected') return 'free';
                return a.status;
            },
            handleCellClick(d, t) { if(this.getCellStatus(d.dateStr, t)!=='free') return; this.selectedSlot={date:d.dateStr, time:t}; this.bookingForm.reason=''; this.showBookingModal=true; },
            
            async submitBooking() {
                if(!this.bookingForm.reason) return alert('请填写预约事由');
                localStorage.setItem('booking_user', JSON.stringify(this.userLoginInfo));
                await fetch('/api/book', { method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: Date.now(), leader: this.currentLeader, date: this.selectedSlot.date, time: this.selectedSlot.time, status: 'pending',
                        applicantName: this.userLoginInfo.name, applicantUnit: this.userLoginInfo.unit, reason: this.bookingForm.reason
                    })
                });
                this.showBookingModal=false; this.fetchData(); alert('已提交');
            },
            async handleApprove(id) { await fetch('/api/approve', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id}) }); this.fetchData(); },
            
            openRejectModal(id) { this.rejectForm = { id: id, suggestion: '' }; this.showRejectModal = true; },
            async confirmReject() {
                if(!this.rejectForm.suggestion) return alert('请填写建议时间');
                await fetch('/api/reject', { method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ id: this.rejectForm.id, suggestion: this.rejectForm.suggestion }) 
                });
                this.showRejectModal = false; this.fetchData();
            },
            
            async changePassword() {
                if(!this.pwdForm.old || !this.pwdForm.new) return alert('请填写完整');
                const res = await fetch('/api/change_password', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({oldPassword:this.pwdForm.old, newPassword:this.pwdForm.new}) });
                const data = await res.json();
                if(data.status === 'success') { alert('修改成功，请重新登录'); this.showPwdModal=false; this.logout(); } else { alert(data.msg || '修改失败'); }
            }
        }
    }).mount('#app');
</script>
</body>
</html>